{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/danish/codeplayground/GMBserp/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = global as unknown as { prisma: PrismaClient }\n\nexport const prisma =\n  globalForPrisma.prisma ||\n  new PrismaClient()\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AAEC,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,sMAAY;AAElB,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 59, "column": 0}, "map": {"version":3,"sources":["file:///Users/danish/codeplayground/GMBserp/src/app/api/proxies/fetch/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { prisma } from '@/lib/prisma';\n\nexport async function POST() {\n    console.log('[ProxyFetch] POST request received at /api/proxies/fetch');\n    try {\n        const sources = [\n            { name: 'TheSpeedX', url: 'https://raw.githubusercontent.com/TheSpeedX/PROXY-List/master/http.txt' },\n            { name: 'ShiftyTR', url: 'https://raw.githubusercontent.com/ShiftyTR/Proxy-List/master/http.txt' },\n            { name: 'Monosans', url: 'https://raw.githubusercontent.com/monosans/proxy-list/main/proxies/http.txt' },\n            { name: 'ProxyListPlus', url: 'https://raw.githubusercontent.com/mmpx12/proxy-list/master/http.txt' },\n        ];\n\n        // Safety Check: Check for active scans\n        const activeScans = await prisma.scan.findFirst({\n            where: { status: 'RUNNING' }\n        });\n\n        if (activeScans) {\n            return NextResponse.json({\n                success: false,\n                logs: ['[CAUTION] Active scan detected.', '[ABORT] Proxy pool synchronization paused to prevent routing instability.'],\n                count: 0\n            });\n        }\n\n        let allProxies: string[] = [];\n        const logs: string[] = [];\n\n        for (const source of sources) {\n            try {\n                console.log(`[ProxyFetch] Fetching from ${source.name}: ${source.url}`);\n                const controller = new AbortController();\n                const timeoutId = setTimeout(() => controller.abort(), 8000); // 8s timeout per source\n\n                const res = await fetch(source.url, {\n                    next: { revalidate: 3600 },\n                    signal: controller.signal\n                }).finally(() => clearTimeout(timeoutId));\n\n                if (!res.ok) throw new Error(`HTTP ${res.status}`);\n\n                const text = await res.text();\n                const lines = text.split('\\n')\n                    .map(l => l.trim())\n                    .filter(l => l.includes(':') && l.length > 5);\n\n                allProxies = [...allProxies, ...lines];\n                console.log(`[ProxyFetch] ${source.name}: Got ${lines.length} proxies`);\n                logs.push(`Fetched ${lines.length} proxies from ${source.name}`);\n            } catch (err: any) {\n                console.error(`[ProxyFetch] Failed ${source.name}:`, err.message);\n                logs.push(`Failed to fetch from ${source.name}: ${err.message}`);\n            }\n        }\n\n        console.log(`[ProxyFetch] Total unique potential proxies: ${new Set(allProxies).size}`);\n        const uniqueEntries = Array.from(new Set(allProxies)).slice(0, 500);\n\n        const proxyData = uniqueEntries.map(entry => {\n            const [host, portStr] = entry.split(':');\n            return {\n                host,\n                port: parseInt(portStr),\n                type: 'DATACENTER' as const,\n                enabled: true\n            };\n        }).filter(p => p.host && !isNaN(p.port));\n\n        console.log(`[ProxyFetch] Performing quality check on 100 discovered routing pairs...`);\n        logs.push('Evaluating routing quality for 100 candidates...');\n\n        const { validateProxyBatch } = await import('@/lib/proxy-tester');\n        const testPool = proxyData.slice(0, 100);\n        const testResults = await validateProxyBatch(testPool, 20);\n\n        // Map all proxies to their final state\n        const processedProxies = proxyData.map(p => {\n            const testResult = testResults.find(r => r.host === p.host && r.port === p.port);\n\n            if (testResult) {\n                return {\n                    ...p,\n                    status: testResult.success ? 'ACTIVE' as const : 'DEAD' as const,\n                    lastTestedAt: new Date()\n                };\n            }\n\n            return {\n                ...p,\n                status: 'UNTESTED' as const\n            };\n        });\n\n        const activeCount = processedProxies.filter(p => p.status === 'ACTIVE').length;\n        console.log(`[ProxyFetch] Quality Check: ${activeCount}/${testPool.length} verified routes.`);\n        logs.push(`Quality Filter: Found ${activeCount} verified and ${proxyData.length - testPool.length} potential routes.`);\n\n        console.log(`[ProxyFetch] Saving ${processedProxies.length} proxies to pool...`);\n\n        // SQLite doesn't support skipDuplicates in createMany. \n        // We filter out existing proxies manually to avoid unique constraint violations.\n        const existingProxies = await (prisma as any).proxy.findMany({\n            select: { host: true, port: true }\n        });\n\n        const existingKeys = new Set(existingProxies.map((p: any) => `${p.host}:${p.port}`));\n        const newProxies = processedProxies.filter(p => !existingKeys.has(`${p.host}:${p.port}`));\n\n        console.log(`[ProxyFetch] Pool has ${existingProxies.length} existing. Detected ${newProxies.length} new unique from ${processedProxies.length} candidates.`);\n        logs.push(`Deduplication: ${existingKeys.size} already in pool, ${newProxies.length} new discovered.`);\n\n        let count = 0;\n        let errors = 0;\n        let firstError = '';\n\n        if (newProxies.length > 0) {\n            for (const p of newProxies) {\n                try {\n                    await (prisma as any).proxy.create({\n                        data: {\n                            host: p.host,\n                            port: p.port,\n                            type: p.type,\n                            enabled: p.enabled,\n                            status: p.status,\n                            lastTestedAt: 'lastTestedAt' in p ? p.lastTestedAt : undefined\n                        }\n                    });\n                    count++;\n                } catch (err: any) {\n                    // Try fallback for stale schema\n                    try {\n                        await (prisma as any).proxy.create({\n                            data: {\n                                host: p.host,\n                                port: p.port,\n                                type: p.type,\n                                enabled: p.enabled\n                            }\n                        });\n                        count++;\n                        // If fallback works, don't increment error, but maybe log a warning once\n                        if (!firstError) firstError = 'Schema mismatch: Saved without status fields.';\n                    } catch (fallbackErr: any) {\n                        errors++;\n                        if (errors === 1) firstError = err.message;\n                        if (errors <= 5) {\n                            console.error(`[ProxyFetch] Insertion error:`, err.message);\n                        }\n                    }\n                }\n            }\n        }\n\n        const currentCount = await (prisma as any).proxy.count();\n        console.log(`[ProxyFetch] Sync complete. Added ${count} new. Total in pool: ${currentCount}. Errors: ${errors}`);\n\n        return NextResponse.json({\n            success: true,\n            sources: sources.map(s => s.name),\n            logs: [\n                ...logs,\n                `[SYNC] Completed: ${count} added, ${processedProxies.length - newProxies.length} skipped duplicates.`,\n                `[STATS] Total routing units in pool: ${currentCount}.`,\n                ...(errors > 0 ? [`[WARN] ${errors} coordinate pairs failed to register. First Error: ${firstError}`] : [])\n            ],\n            count: count\n        });\n\n    } catch (error: any) {\n        console.error('[ProxyFetch] Global error:', error);\n        return NextResponse.json({\n            success: false,\n            error: 'Failed to fetch proxies',\n            details: error.message\n        }, { status: 500 });\n    }\n}\n"],"names":[],"mappings":"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"}}]
}